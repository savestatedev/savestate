<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Incremental Snapshots ‚Äî SaveState Docs</title>
<meta name="description" content="How SaveState incremental snapshots work: delta computation, chain depth, auto-detection, and reconstruction.">
<link rel="icon" type="image/png" href="../logo.png">
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&family=JetBrains+Mono:wght@400;500;600;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="style.css">
</head>
<body>

<!-- Header -->
<header class="docs-header">
  <div class="header-left">
    <button class="hamburger" onclick="toggleSidebar()" aria-label="Menu">
      <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><line x1="3" y1="6" x2="21" y2="6"/><line x1="3" y1="12" x2="21" y2="12"/><line x1="3" y1="18" x2="21" y2="18"/></svg>
    </button>
    <a href="/" class="header-logo">
      <img src="../logo.png" alt="SaveState" width="26" height="26">
      <span>SaveState</span>
    </a>
    <div class="header-divider"></div>
    <span class="header-docs-label">Docs</span>
  </div>
  <div class="header-right">
    <a href="/">Home</a>
    <a href="https://github.com/savestatedev/savestate" target="_blank" rel="noopener">GitHub</a>
    <a href="https://www.npmjs.com/package/@savestate/cli" target="_blank" rel="noopener">npm</a>
  </div>
</header>

<div class="sidebar-overlay" id="sidebarOverlay" onclick="toggleSidebar()"></div>

<aside class="docs-sidebar" id="sidebar">
  <a href="/" class="sidebar-back">
    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="15 18 9 12 15 6"/></svg>
    Back to savestate.dev
  </a>
  <div class="sidebar-section">
    <span class="sidebar-label">Getting Started</span>
    <ul class="sidebar-nav">
      <li><a href="/docs/">Installation &amp; Quick Start</a></li>
      <li><a href="/docs/cli.html">CLI Reference</a></li>
    </ul>
  </div>
  <div class="sidebar-section">
    <span class="sidebar-label">Core Concepts</span>
    <ul class="sidebar-nav">
      <li><a href="/docs/adapters.html">Platform Adapters</a></li>
      <li><a href="/docs/storage.html">Storage Backends</a></li>
      <li><a href="/docs/encryption.html">Encryption</a></li>
    </ul>
  </div>
  <div class="sidebar-section">
    <span class="sidebar-label">Advanced</span>
    <ul class="sidebar-nav">
      <li><a href="/docs/format.html">SAF Archive Format</a></li>
      <li><a href="/docs/incremental.html" class="active">Incremental Snapshots</a></li>
    </ul>
  </div>
  <div class="sidebar-section">
    <span class="sidebar-label">Plans</span>
    <ul class="sidebar-nav">
      <li><a href="/docs/pricing.html">Pricing</a></li>
    </ul>
  </div>
</aside>

<!-- Main -->
<main class="docs-main">
  <div class="docs-content">
    <h1>Incremental Snapshots</h1>
    <p class="subtitle">Like git ‚Äî only captures what changed. Full version history, minimal storage.</p>

    <h2 id="how-it-works">How It Works</h2>
    <p>Instead of storing a full copy every time, incremental snapshots compute a <strong>delta</strong> against the previous snapshot and store only changed files.</p>

    <pre><code><span class="code-comment">                       Full chain:</span>
<span class="code-cmd">base (full)</span> ‚Üí <span class="code-flag">delta-1</span> ‚Üí <span class="code-flag">delta-2</span> ‚Üí <span class="code-flag">delta-3</span> ‚Üí <span class="code-cmd">base (full)</span> ‚Üí <span class="code-flag">delta-4</span> ‚Üí ...
    <span class="code-output">‚Üë</span>                                           <span class="code-output">‚Üë</span>
  <span class="code-output">chain depth 0</span>                              <span class="code-output">auto-forced at depth 10</span></code></pre>

    <h3>The delta process</h3>
    <ol>
      <li><strong>Hash current state:</strong> SHA-256 hash every file in the new snapshot</li>
      <li><strong>Load parent hashes:</strong> Read the content hashes from the previous snapshot's delta manifest (or compute them for full snapshots)</li>
      <li><strong>Compare:</strong> Identify which files are added, modified, or removed</li>
      <li><strong>Store delta:</strong> Only save the changed and added files, plus a delta manifest listing all changes</li>
    </ol>

    <div class="terminal-block">
      <div class="terminal-bar">
        <span class="terminal-dot"></span><span class="terminal-dot"></span><span class="terminal-dot"></span>
        <span class="terminal-bar-title">Incremental snapshot output</span>
      </div>
      <pre><code><span class="code-prompt">$</span> savestate snapshot
<span class="code-success">‚úì</span> <span class="code-output">Platform detected: clawdbot</span>
<span class="code-success">‚úì</span> <span class="code-output">Incremental snapshot created!</span>
  <span class="code-output">Changes: <span class="code-success">+3</span> added, <span class="code-flag">~5</span> modified, 42 unchanged</span>
  <span class="code-output">Saved:   <span class="code-flag">847 KB</span> vs full snapshot</span>
<span class="code-success">‚úì</span> <span class="code-output">Encrypted &amp; stored (12.4 KB)</span></code></pre>
    </div>

    <h2 id="auto-detection">Auto-Detection</h2>
    <p>Incremental snapshots are <strong>automatic</strong>. When you run <code>savestate snapshot</code>:</p>
    <ol>
      <li>SaveState checks if a previous snapshot exists</li>
      <li>If yes, it loads the parent's content hashes and computes a delta</li>
      <li>If no previous snapshot exists (first run), it creates a full snapshot</li>
    </ol>

    <p>You don't need to do anything special ‚Äî incrementals are the default behavior.</p>

    <h2 id="force-full">Forcing a Full Snapshot</h2>
    <p>Use the <code>--full</code> flag to bypass incremental detection and create a complete snapshot:</p>
    <pre><code><span class="code-prompt">$</span> savestate snapshot --full</code></pre>

    <p>Full snapshots are also <strong>automatically forced</strong> when:</p>
    <ul>
      <li><strong>Chain depth reaches 10:</strong> After 10 consecutive deltas, a full snapshot is created to keep the chain short and restore fast</li>
      <li><strong>Change ratio exceeds 70%:</strong> If more than 70% of files changed, a full snapshot is more efficient than a delta</li>
      <li><strong>No parent found:</strong> First snapshot or parent can't be loaded</li>
    </ul>

    <h2 id="chain-depth">Chain Depth</h2>

    <table>
      <thead>
        <tr><th>Constant</th><th>Value</th><th>Meaning</th></tr>
      </thead>
      <tbody>
        <tr><td><code>MAX_CHAIN_DEPTH</code></td><td>10</td><td>Maximum deltas before forcing a full snapshot</td></tr>
        <tr><td><code>FULL_SNAPSHOT_THRESHOLD</code></td><td>0.7 (70%)</td><td>If this fraction of files changed, force full</td></tr>
      </tbody>
    </table>

    <p>This ensures that restoring any snapshot never requires walking more than 10 chain links ‚Äî keeping restore time fast even with hundreds of snapshots.</p>

    <h2 id="delta-manifest">Delta Manifest</h2>
    <p>Incremental archives contain a <code>meta/delta-manifest.json</code> with full change tracking:</p>

    <pre><code>{
  <span class="code-key">"parentId"</span>: <span class="code-value">"ss-2026-01-26T09-30-00-b7c1m4"</span>,
  <span class="code-key">"baseId"</span>: <span class="code-value">"ss-2026-01-20T00-00-00-x1y2z3"</span>,
  <span class="code-key">"chainDepth"</span>: <span class="code-value">3</span>,
  <span class="code-key">"resultHashes"</span>: {
    <span class="code-key">"files"</span>: {
      <span class="code-key">"identity/personality.md"</span>: <span class="code-value">"sha256:a1b2c3..."</span>,
      <span class="code-key">"memory/core.json"</span>: <span class="code-value">"sha256:d4e5f6..."</span>
    },
    <span class="code-key">"count"</span>: <span class="code-value">47</span>,
    <span class="code-key">"rootHash"</span>: <span class="code-value">"sha256:..."</span>
  },
  <span class="code-key">"entries"</span>: [
    { <span class="code-key">"path"</span>: <span class="code-value">"memory/core.json"</span>, <span class="code-key">"type"</span>: <span class="code-value">"modified"</span>, <span class="code-key">"hash"</span>: <span class="code-value">"sha256:..."</span>, <span class="code-key">"size"</span>: <span class="code-value">4096</span> },
    { <span class="code-key">"path"</span>: <span class="code-value">"identity/skills.json"</span>, <span class="code-key">"type"</span>: <span class="code-value">"added"</span>, <span class="code-key">"hash"</span>: <span class="code-value">"sha256:..."</span>, <span class="code-key">"size"</span>: <span class="code-value">1024</span> },
    { <span class="code-key">"path"</span>: <span class="code-value">"identity/old-config.json"</span>, <span class="code-key">"type"</span>: <span class="code-value">"removed"</span> }
  ],
  <span class="code-key">"stats"</span>: {
    <span class="code-key">"added"</span>: <span class="code-value">1</span>,
    <span class="code-key">"modified"</span>: <span class="code-value">1</span>,
    <span class="code-key">"removed"</span>: <span class="code-value">1</span>,
    <span class="code-key">"unchanged"</span>: <span class="code-value">44</span>,
    <span class="code-key">"totalFiles"</span>: <span class="code-value">46</span>,
    <span class="code-key">"bytesSaved"</span>: <span class="code-value">867328</span>
  }
}</code></pre>

    <h3>Delta entry types</h3>
    <table>
      <thead>
        <tr><th>Type</th><th>Meaning</th><th>File in archive?</th></tr>
      </thead>
      <tbody>
        <tr><td><code>added</code></td><td>New file not in parent</td><td>Yes ‚Äî full content included</td></tr>
        <tr><td><code>modified</code></td><td>File exists but content changed (different SHA-256)</td><td>Yes ‚Äî full new content included</td></tr>
        <tr><td><code>removed</code></td><td>File was in parent but not in current</td><td>No ‚Äî just the path in the manifest</td></tr>
      </tbody>
    </table>

    <h2 id="reconstruction">Reconstruction</h2>
    <p>When restoring from an incremental snapshot, SaveState <strong>reconstructs</strong> the full state by walking the chain:</p>

    <pre><code><span class="code-comment">Reconstruction process:</span>

<span class="code-output">1. Walk backwards from target snapshot to find the base (full) snapshot</span>
<span class="code-output">2. Load the base snapshot ‚Üí full file map</span>
<span class="code-output">3. Apply each delta in order:</span>
   <span class="code-success">   a. Add/overwrite files from the delta</span>
   <span class="code-success">   b. Remove files marked as 'removed'</span>
<span class="code-output">4. Result: complete reconstructed state</span>

<span class="code-comment">Example chain walk:</span>
<span class="code-cmd">base</span> ‚Üí <span class="code-flag">delta-1</span> ‚Üí <span class="code-flag">delta-2</span> ‚Üí <span class="code-flag">target</span>
  <span class="code-output">‚Üì</span>         <span class="code-output">‚Üì</span>           <span class="code-output">‚Üì</span>          <span class="code-output">‚Üì</span>
<span class="code-output">47 files</span>  <span class="code-output">+2, ~3</span>     <span class="code-output">~1, -1</span>    <span class="code-output">+1</span>
                                   <span class="code-output">= 49 files</span></code></pre>

    <p>This is transparent ‚Äî you just run <code>savestate restore</code> and it handles the chain walking automatically.</p>

    <h2 id="content-hashing">Content Hashing</h2>
    <p>Every file is hashed with SHA-256 for change detection:</p>
    <pre><code><span class="code-type">interface</span> <span class="code-cmd">ContentHashes</span> {
  <span class="code-key">files</span>: Record&lt;<span class="code-type">string</span>, <span class="code-type">string</span>&gt;;   <span class="code-comment">// path ‚Üí SHA-256</span>
  <span class="code-key">count</span>: <span class="code-type">number</span>;                    <span class="code-comment">// total file count</span>
  <span class="code-key">rootHash</span>: <span class="code-type">string</span>;                 <span class="code-comment">// hash of all hashes (quick comparison)</span>
}</code></pre>

    <p>The <code>rootHash</code> is computed by sorting all <code>path:hash</code> pairs and hashing the result ‚Äî a quick way to check if anything changed at all before computing the full delta.</p>

    <div class="callout callout-tip">
      <span class="callout-label">üí°</span> The <code>resultHashes</code> field in the delta manifest stores the hashes of the <em>full</em> state after applying the delta. This means the next incremental snapshot can compare directly without needing to reconstruct.
    </div>

    <!-- Page Nav -->
    <div class="page-nav">
      <a href="/docs/format.html">
        <span class="page-nav-label">‚Üê Previous</span>
        <span class="page-nav-title">SAF Archive Format</span>
      </a>
      <a href="/docs/pricing.html" class="next">
        <span class="page-nav-label">Next ‚Üí</span>
        <span class="page-nav-title">Pricing</span>
      </a>
    </div>
  </div>

  <footer class="docs-footer">
    <span>MIT Licensed ¬∑ <a href="https://github.com/savestatedev/savestate">SaveState on GitHub</a></span>
    <span>v0.2.1</span>
  </footer>
</main>

<script>
function toggleSidebar() {
  document.getElementById('sidebar').classList.toggle('open');
  document.getElementById('sidebarOverlay').classList.toggle('show');
}
</script>
</body>
</html>
