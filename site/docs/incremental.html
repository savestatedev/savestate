<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Incremental Snapshots — SaveState Docs</title>
  <meta name="description" content="Delta-only captures, snapshot chains, and automatic reconstruction in SaveState.">
  <link rel="stylesheet" href="docs.css">
  <link rel="icon" href="/logo.svg" type="image/svg+xml">
</head>
<body>
  <button class="mobile-toggle" onclick="toggleSidebar()" aria-label="Toggle navigation">☰</button>
  <div class="sidebar-overlay" id="overlay" onclick="toggleSidebar()"></div>

  <div class="layout">
    <nav class="sidebar" id="sidebar">
      <div class="sidebar-header">
        <a href="https://savestate.dev" class="sidebar-logo">
          <img src="/logo.svg" alt="">
          SaveState <span>docs</span>
        </a>
        <a href="https://savestate.dev" class="sidebar-back">← Back to savestate.dev</a>
      </div>
      <div class="sidebar-nav">
        <div class="sidebar-section">
          <div class="sidebar-section-title">Getting Started</div>
          <a href="/docs/">Quick Start</a>
          <a href="/docs/cli.html">CLI Reference</a>
        </div>
        <div class="sidebar-section">
          <div class="sidebar-section-title">Core Concepts</div>
          <a href="/docs/adapters.html">Platform Adapters</a>
          <a href="/docs/storage.html">Storage Backends</a>
          <a href="/docs/encryption.html">Encryption</a>
          <a href="/docs/incremental.html" class="active">Incremental Snapshots</a>
          <a href="/docs/format.html">Archive Format (SAF)</a>
        </div>
        <div class="sidebar-section">
          <div class="sidebar-section-title">Plans</div>
          <a href="/docs/pricing.html">Pricing</a>
        </div>
      </div>
    </nav>

    <main class="main">
      <div class="content">
        <h1>Incremental Snapshots</h1>
        <p class="subtitle">Like git — only captures what changed. Full history, tiny storage.</p>

        <h2 id="how">How It Works</h2>
        <p>Instead of storing a full copy every time, incremental snapshots capture only what changed since the last snapshot. This dramatically reduces storage usage and speeds up backups.</p>

        <ol>
          <li><strong>Hash every file</strong> in the current snapshot (SHA-256)</li>
          <li><strong>Load the parent</strong> snapshot's content hashes</li>
          <li><strong>Compare</strong> — identify added, modified, and removed files</li>
          <li><strong>Store only the delta</strong> (changed + added files)</li>
          <li>On restore: <strong>reconstruct</strong> by applying deltas from base → current</li>
        </ol>

        <h2 id="chain">Snapshot Chains</h2>
        <p>Snapshots form a chain. The first snapshot is always a <strong>full snapshot</strong>. Subsequent snapshots are <strong>deltas</strong> that reference their parent:</p>

<pre><code><span class="c-accent">base (full)</span> → <span class="c-flag">delta-1</span> → <span class="c-flag">delta-2</span> → <span class="c-flag">delta-3</span> (current)
  128 KB         8 KB        12 KB        5 KB</code></pre>

        <p>In this example, 4 snapshots use only 153 KB instead of 512 KB (4 × 128 KB). That's <strong>70% savings</strong>.</p>

        <h3>Automatic full snapshots</h3>
        <p>SaveState automatically forces a full snapshot in two cases:</p>

        <table>
          <thead>
            <tr><th>Condition</th><th>Threshold</th><th>Reason</th></tr>
          </thead>
          <tbody>
            <tr>
              <td><strong>Chain depth</strong></td>
              <td>10 deltas</td>
              <td>Keeps restore fast (max 10 deltas to reconstruct)</td>
            </tr>
            <tr>
              <td><strong>Change ratio</strong></td>
              <td>≥ 70% files changed</td>
              <td>Delta would be nearly as large as a full snapshot</td>
            </tr>
          </tbody>
        </table>

        <p>You can also force a full snapshot manually:</p>
<pre><code><span class="c-cmd">savestate</span> snapshot <span class="c-flag">--full</span></code></pre>

        <h2 id="delta-manifest">Delta Manifest</h2>
        <p>Each incremental archive includes a <code>meta/delta-manifest.json</code> that describes exactly what changed:</p>

<pre><code>{
  <span class="c-string">"parentId"</span>: <span class="c-string">"ss-2026-01-25T09-30-00-b7e1df"</span>,
  <span class="c-string">"baseId"</span>: <span class="c-string">"ss-2026-01-20T12-00-00-c4a9e2"</span>,
  <span class="c-string">"chainDepth"</span>: <span class="c-value">3</span>,
  <span class="c-string">"resultHashes"</span>: {
    <span class="c-string">"files"</span>: {
      <span class="c-string">"manifest.json"</span>: <span class="c-string">"sha256:a1b2c3..."</span>,
      <span class="c-string">"identity/personality.md"</span>: <span class="c-string">"sha256:d4e5f6..."</span>,
      <span class="c-comment">// ... hashes for ALL files after applying this delta</span>
    },
    <span class="c-string">"count"</span>: <span class="c-value">42</span>,
    <span class="c-string">"rootHash"</span>: <span class="c-string">"sha256:..."</span>
  },
  <span class="c-string">"entries"</span>: [
    { <span class="c-string">"path"</span>: <span class="c-string">"memory/2026-01-27.md"</span>, <span class="c-string">"type"</span>: <span class="c-string">"added"</span>, <span class="c-string">"hash"</span>: <span class="c-string">"sha256:..."</span>, <span class="c-string">"size"</span>: <span class="c-value">1024</span> },
    { <span class="c-string">"path"</span>: <span class="c-string">"identity/personality.md"</span>, <span class="c-string">"type"</span>: <span class="c-string">"modified"</span>, <span class="c-string">"hash"</span>: <span class="c-string">"sha256:..."</span>, <span class="c-string">"size"</span>: <span class="c-value">4096</span> },
    { <span class="c-string">"path"</span>: <span class="c-string">"conversations/old-thread.json"</span>, <span class="c-string">"type"</span>: <span class="c-string">"removed"</span> }
  ],
  <span class="c-string">"stats"</span>: {
    <span class="c-string">"added"</span>: <span class="c-value">1</span>,
    <span class="c-string">"modified"</span>: <span class="c-value">1</span>,
    <span class="c-string">"removed"</span>: <span class="c-value">1</span>,
    <span class="c-string">"unchanged"</span>: <span class="c-value">39</span>,
    <span class="c-string">"totalFiles"</span>: <span class="c-value">42</span>,
    <span class="c-string">"bytesSaved"</span>: <span class="c-value">98304</span>
  }
}</code></pre>

        <h2 id="content-hashing">Content Hashing</h2>
        <p>Every file in a snapshot is hashed with SHA-256. The <strong>root hash</strong> is computed by sorting all path:hash pairs alphabetically and hashing the result:</p>

<pre><code><span class="c-comment">// Individual file hashes</span>
identity/personality.md → sha256:a1b2c3...
manifest.json → sha256:d4e5f6...
memory/core.json → sha256:g7h8i9...

<span class="c-comment">// Root hash = SHA-256 of sorted "path:hash" pairs joined by newlines</span>
rootHash = SHA-256(<span class="c-string">"identity/personality.md:a1b2c3...\nmanifest.json:d4e5f6...\nmemory/core.json:g7h8i9..."</span>)</code></pre>

        <p>The root hash provides a quick way to check if two snapshots are identical without comparing every file.</p>

        <h2 id="reconstruction">Reconstruction</h2>
        <p>When restoring from an incremental snapshot, SaveState automatically reconstructs the full state by walking the chain:</p>

        <ol>
          <li><strong>Walk backward</strong> from the target snapshot, following <code>parentId</code> links</li>
          <li><strong>Find the base</strong> (full snapshot) — it has no <code>delta-manifest.json</code></li>
          <li><strong>Start with the base</strong> as the initial file map</li>
          <li><strong>Apply each delta in order:</strong>
            <ul>
              <li>Add/overwrite files from the delta archive</li>
              <li>Remove files marked as <code>"removed"</code></li>
            </ul>
          </li>
          <li><strong>Result:</strong> Complete file map as if it were a full snapshot</li>
        </ol>

<pre><code><span class="c-comment">// Reconstruction chain</span>
base (full)     <span class="c-comment">// Start: all files</span>
  ↓ apply delta-1   <span class="c-comment">// +2 added, ~1 modified, -0 removed</span>
  ↓ apply delta-2   <span class="c-comment">// +0 added, ~3 modified, -1 removed</span>
  ↓ apply delta-3   <span class="c-comment">// +1 added, ~1 modified, -1 removed</span>
  = <span class="c-accent">reconstructed full snapshot</span></code></pre>

        <p>This is transparent to the user — <code>savestate restore</code> handles reconstruction automatically.</p>

        <h2 id="delta-archive">Delta Archive Contents</h2>
        <p>An incremental archive is smaller than a full archive because it only contains:</p>

        <ul>
          <li><code>manifest.json</code> — Always present (updated metadata)</li>
          <li><code>meta/delta-manifest.json</code> — The delta details</li>
          <li><code>meta/platform.json</code> — Platform info</li>
          <li><code>meta/snapshot-chain.json</code> — Chain links</li>
          <li><code>meta/restore-hints.json</code> — Restore instructions</li>
          <li><strong>Only changed/added files</strong> — Everything else is omitted</li>
        </ul>

        <div class="callout">
          <strong>How to tell if a snapshot is incremental</strong>
          If the archive contains <code>meta/delta-manifest.json</code>, it's incremental. If not, it's a full snapshot.
        </div>

        <h2 id="detection">Automatic Parent Detection</h2>
        <p>When you run <code>savestate snapshot</code> (without <code>--full</code>), SaveState automatically:</p>
        <ol>
          <li>Checks if a previous snapshot exists in the index</li>
          <li>Loads the latest snapshot's content hashes</li>
          <li>If the latest was also incremental, follows the chain to determine <code>baseId</code> and <code>chainDepth</code></li>
          <li>Computes the delta against the parent</li>
          <li>If the chain is too deep (≥10) or too much changed (≥70%), forces a full snapshot instead</li>
        </ol>

        <p>If no previous snapshot exists, the first snapshot is always full.</p>

        <h2 id="storage-savings">Storage Savings</h2>
        <p>Real-world example from a Clawdbot workspace:</p>

        <table>
          <thead>
            <tr><th>Snapshot</th><th>Type</th><th>Size</th><th>Changed</th></tr>
          </thead>
          <tbody>
            <tr><td>ss-01-20</td><td><span class="badge badge-blue">Full</span></td><td>128 KB</td><td>—</td></tr>
            <tr><td>ss-01-21</td><td><span class="badge badge-green">Delta</span></td><td>8 KB</td><td>2 files</td></tr>
            <tr><td>ss-01-22</td><td><span class="badge badge-green">Delta</span></td><td>12 KB</td><td>3 files</td></tr>
            <tr><td>ss-01-23</td><td><span class="badge badge-green">Delta</span></td><td>5 KB</td><td>1 file</td></tr>
            <tr><td>ss-01-24</td><td><span class="badge badge-green">Delta</span></td><td>15 KB</td><td>4 files</td></tr>
            <tr><td>ss-01-25</td><td><span class="badge badge-green">Delta</span></td><td>6 KB</td><td>2 files</td></tr>
          </tbody>
        </table>

        <p><strong>Without incremental:</strong> 6 × 128 KB = 768 KB<br>
           <strong>With incremental:</strong> 128 + 8 + 12 + 5 + 15 + 6 = 174 KB<br>
           <strong>Savings:</strong> 77%</p>
      </div>
    </main>
  </div>

  <script>
    function toggleSidebar() {
      document.getElementById('sidebar').classList.toggle('open');
      document.getElementById('overlay').classList.toggle('open');
    }
  </script>
</body>
</html>
